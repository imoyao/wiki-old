---
title: first-wiki
toc: true
categories:
  - "\U0001F4BB工作"
  - 存储
  - CEPH
  - troubleshooting
date: 2020-05-23 11:02:28
tags:
---

## 1. 故障现场

- 通过监控发现集群状态是 HEALTH_ERR 状态， 并且发现 mds0: Metadata damage detected。 顾名思义，猜测应该是元信息损坏导致的。 [![image.png](https://camo.githubusercontent.com/6286efebac7a7dacb10f8a3021fee6ca0c8bfc1d/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d333061626636643437623963666164662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/6286efebac7a7dacb10f8a3021fee6ca0c8bfc1d/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d333061626636643437623963666164662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 2. 分析 damage 是啥原因导致

[![image.png](https://camo.githubusercontent.com/55edd8da7d9df5deeb29bae5aadb63ca766ab3fc/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d383661383263353665393663623363622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/55edd8da7d9df5deeb29bae5aadb63ca766ab3fc/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d383661383263353665393663623363622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

**大概意思是：**

- 从元数据存储池读取时，遇到了元数据损坏或丢失的情况。这条消息表明损坏之处已经被妥善隔离了，以使 MDS 继续运作，如此一来，若有客户端访问损坏的子树就返回 IO 错误。关于损坏的细节信息可用 damage ls 管理套接字命令获取。只要一遇到受损元数据，此消息就会立即出现。

## 3. 查看 damage ls

- 通过指令查询到 damage ls 显示的信息，可以发现里面有个 ino 编号。 [![image.png](https://camo.githubusercontent.com/0a3af6ec4e95cc210f5918d63e61bf274d6548f2/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d666662366162643732613862333138312e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/0a3af6ec4e95cc210f5918d63e61bf274d6548f2/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d666662366162643732613862333138312e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 4. 通过转换拿到十六进制 ino

- 通过 ino:1099519182934 -> ino: 10000734856 [![image.png](https://camo.githubusercontent.com/9ee23173b4514b1b5aef411ac3b309119f3fbc88/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d323535393532393566383065396534632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/9ee23173b4514b1b5aef411ac3b309119f3fbc88/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d323535393532393566383065396534632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 5. 检查是否属于目录(10000734856)

- 通过指令查找发现该 ino 确定是目录 [![image.png](https://camo.githubusercontent.com/5db8b7eb6f7530e7fe736922e947410ecfe32746/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d303039306538663131323734326533332e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/5db8b7eb6f7530e7fe736922e947410ecfe32746/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d303039306538663131323734326533332e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 6. 确定目录名

[![image.png](https://camo.githubusercontent.com/81f9c6ba9062737fdba1871dd82437cdc3178d9a/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d313036396335623139383732313766662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/81f9c6ba9062737fdba1871dd82437cdc3178d9a/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d313036396335623139383732313766662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 7. 该目录下面的所有文件

[![image.png](https://camo.githubusercontent.com/d33ad51dd15e5361720b312a55ab1f24992524cd/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d383865653336613335343733393561362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/d33ad51dd15e5361720b312a55ab1f24992524cd/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d383865653336613335343733393561362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 8. 查看 fs 挂载的目录是否匹配

```plain
ceph fs ls -f json-pretty
```

## 9. 修复这个目录元信息

```plain
ceph --admin-daemon /var/run/ceph/ceph-mds.00.asok  scrub_path /dir repair
```

[![image.png](https://camo.githubusercontent.com/501c2e06738e8814047da61a5d39b6c90cb7150e/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d313564346135613264373736646162622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/501c2e06738e8814047da61a5d39b6c90cb7150e/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d313564346135613264373736646162622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 10. 跟踪代码

**参考文件：**

- https://github.com/ceph/ceph/blob/5cdf9c3380098f5d2b1d988ab623c74baad55ee3/src/mds/MDSRank.cc#L2245
- https://github.com/ceph/ceph/blob/5cdf9c3380098f5d2b1d988ab623c74baad55ee3/src/mds/MDCache.cc#L12197

[![image.png](https://camo.githubusercontent.com/8dc0db0c416cf04adb7061a21d6225a848ed66d3/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d363337363639376438323438623730662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/8dc0db0c416cf04adb7061a21d6225a848ed66d3/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d363337363639376438323438623730662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)[![image.png](https://camo.githubusercontent.com/229338421b416e79bfec5195b63f96a45ed43466/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d363135383061623662323839326231632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/229338421b416e79bfec5195b63f96a45ed43466/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d363135383061623662323839326231632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 11. 总结

### 11.1 问题过程回顾

- 集群 ERR
- 发现 mds0: Metadata damage detected
- 查看 damage ino
- 根据 ino 定位跟踪目录
- 根据目录名知道业务存储的数据
- 修复问题

## 12. 修复方案

### 12.1 方案一：删除 ino 对应的目录（生产环境实战演练过)

1.业务方备份迁移数据 2.查看 damage ls [![image.png](https://camo.githubusercontent.com/dde5bafa1f821a9cbef87395bc3c2f25476eba77/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d366636613063663339643934613764392e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/dde5bafa1f821a9cbef87395bc3c2f25476eba77/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d366636613063663339643934613764392e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)3.检查该 ino 确实没有对应的目录 [![image.png](https://camo.githubusercontent.com/6567b413826a8283e6bd473256330d5c42d424d5/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d623630353038346431303361363665612e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/6567b413826a8283e6bd473256330d5c42d424d5/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d623630353038346431303361363665612e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)4.删除 damage rm 信息 [![image.png](https://camo.githubusercontent.com/3324fe445f707cc79502082a0b74df8738f6a2f8/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d613266653464346531613533353031662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/3324fe445f707cc79502082a0b74df8738f6a2f8/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d613266653464346531613533353031662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

5.检查集群状态(集群状态从 ERR 恢复到 WARN) [![image.png](https://camo.githubusercontent.com/a8ba2173f5880e0ee8a5aac5511219a3a79b52de/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d653064323435643835653635373339362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/a8ba2173f5880e0ee8a5aac5511219a3a79b52de/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d653064323435643835653635373339362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

### 12.2 方案二：修复该目录元信息

1.通过指令修复目录

```plain
ceph --admin-daemon /var/run/ceph/ceph-mds.ceph-newpublic-osd02.py.asok scrub_path /dir/xxx repair
```